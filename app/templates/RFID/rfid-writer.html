<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <title>RFID Writer - HackMaster Pi</title>
    <meta name="theme-color" content="#0f0f17">
</head>
<body>
    <div class="container">
        <div class="header-container">
            <a href="/" class="back-button">← BACK</a>
            <h1>RFID Writer</h1>
        </div>
        
        <div class="info-guide">
            <h3>RFID Writing Tool</h3>
            <p>Use this tool to write data to RFID cards. You can either select from your saved cards or enter custom data.</p>
        </div>
        
        <div class="control-panel">
            <h2>Write Mode</h2>
            <div class="form-group">
                <label for="write-mode">SELECT WRITING MODE:</label>
                <select id="write-mode" class="profile-select">
                    <option value="saved">FROM SAVED CARDS</option>
                    <option value="custom">CUSTOM DATA</option>
                </select>
            </div>
        </div>
        
        <!-- 已儲存卡片選擇區域 -->
        <div id="saved-mode" class="write-mode-panel">
            <h2>Select Saved Card</h2>
            <div class="form-group">
                <label for="saved-card-select">SELECT CARD TO CLONE:</label>
                <select id="saved-card-select" class="profile-select">
                    <option value="">-- SELECT A CARD --</option>
                </select>
            </div>
            
            <div id="selected-card-info" class="profile-item" style="display: none;">
                <div class="profile-details">
                    <div class="profile-name" id="selected-card-name">Card Name</div>
                    <div class="profile-info">
                        <span class="profile-label">UID:</span>
                        <span class="profile-value" id="selected-card-uid">-</span>
                    </div>
                    <div class="profile-info">
                        <span class="profile-label">TYPE:</span>
                        <span class="profile-value" id="selected-card-type">-</span>
                    </div>
                    <div class="profile-info">
                        <span class="profile-label">DATA:</span>
                        <span class="profile-value" id="selected-card-data">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 自定義資料輸入區域 -->
        <div id="custom-mode" class="write-mode-panel" style="display: none;">
            <h2>Custom Card Data</h2>
            <div class="form-group">
                <label for="custom-uid">UID (HEXADECIMAL):</label>
                <input type="text" id="custom-uid" placeholder="Enter UID in hex format (e.g., 1A2B3C4D)" maxlength="16">
                <p class="info-values">Some cards may not support UID writing</p>
            </div>
            
            <div class="form-group">
                <label for="custom-card-type">CARD TYPE:</label>
                <select id="custom-card-type">
                    <option value="Mifare Classic 1K">MIFARE CLASSIC 1K</option>
                    <option value="Mifare Classic 4K">MIFARE CLASSIC 4K</option>
                    <option value="Mifare Ultralight">MIFARE ULTRALIGHT</option>
                    <option value="Mifare Desfire">MIFARE DESFIRE</option>
                    <option value="Other">OTHER</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="custom-data">CUSTOM DATA:</label>
                <textarea id="custom-data" rows="5" placeholder="Enter custom data to write to card"></textarea>
            </div>
            
            <div class="form-group">
                <label for="custom-name">SAVE AS (OPTIONAL):</label>
                <input type="text" id="custom-name" placeholder="Enter a name to save this configuration">
            </div>
        </div>
        
        <button id="control-button" type="button">
            <span id="button-text">START WRITING</span>
            <span class="loading" id="loading-spinner" style="display: none;"></span>
        </button>
        <div class="status-indicator" id="status-indicator">SELECT A CARD OR ENTER CUSTOM DATA</div>
        
        <div id="write-result" class="info-guide" style="display: none; margin-top: 30px;">
            <h3>Write Result</h3>
            <div id="result-content"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 獲取DOM元素
            const writeMode = document.getElementById('write-mode');
            const savedModePanel = document.getElementById('saved-mode');
            const customModePanel = document.getElementById('custom-mode');
            const savedCardSelect = document.getElementById('saved-card-select');
            const selectedCardInfo = document.getElementById('selected-card-info');
            const selectedCardName = document.getElementById('selected-card-name');
            const selectedCardUid = document.getElementById('selected-card-uid');
            const selectedCardType = document.getElementById('selected-card-type');
            const selectedCardData = document.getElementById('selected-card-data');
            const customUid = document.getElementById('custom-uid');
            const customCardType = document.getElementById('custom-card-type');
            const customData = document.getElementById('custom-data');
            const customName = document.getElementById('custom-name');
            const controlButton = document.getElementById('control-button');
            const buttonText = document.getElementById('button-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const statusIndicator = document.getElementById('status-indicator');
            const writeResult = document.getElementById('write-result');
            const resultContent = document.getElementById('result-content');
            
            // 儲存卡片集合
            let cardCollection = [];
            let selectedCard = null;
            
            // 嘗試從 localStorage 加載已儲存的卡片
            try {
                const savedCards = localStorage.getItem('rfidCards');
                if (savedCards) {
                    cardCollection = JSON.parse(savedCards);
                    populateSavedCardSelect();
                }
            } catch (e) {
                console.error('Error loading saved cards:', e);
            }
            
            // 寫入模式切換
            writeMode.addEventListener('change', function() {
                if (this.value === 'saved') {
                    savedModePanel.style.display = 'block';
                    customModePanel.style.display = 'none';
                    
                    // 檢查是否有選中的卡片
                    if (savedCardSelect.value) {
                        buttonText.textContent = 'WRITE SELECTED CARD';
                        controlButton.disabled = false;
                    } else {
                        buttonText.textContent = 'START WRITING';
                        controlButton.disabled = true;
                    }
                    
                    statusIndicator.textContent = 'SELECT A SAVED CARD TO WRITE';
                } else {
                    savedModePanel.style.display = 'none';
                    customModePanel.style.display = 'block';
                    buttonText.textContent = 'WRITE CUSTOM DATA';
                    controlButton.disabled = false;
                    statusIndicator.textContent = 'ENTER CUSTOM DATA TO WRITE';
                }
            });
            
            // 填充已保存卡片選擇下拉框
            function populateSavedCardSelect() {
                // 清空現有選項（保留第一個）
                while (savedCardSelect.options.length > 1) {
                    savedCardSelect.remove(1);
                }
                
                // 沒有卡片的情況
                if (cardCollection.length === 0) {
                    const option = document.createElement('option');
                    option.text = 'NO SAVED CARDS AVAILABLE';
                    option.disabled = true;
                    savedCardSelect.add(option);
                    controlButton.disabled = true;
                    return;
                }
                
                // 添加每個卡片作為選項
                cardCollection.forEach((card, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.text = `${card.name} (${card.uid})`;
                    savedCardSelect.add(option);
                });
            }
            
            // 已保存卡片選擇事件
            savedCardSelect.addEventListener('change', function() {
                if (this.value === '') {
                    selectedCardInfo.style.display = 'none';
                    buttonText.textContent = 'START WRITING';
                    controlButton.disabled = true;
                    return;
                }
                
                const index = parseInt(this.value);
                selectedCard = cardCollection[index];
                
                // 顯示選中卡片的詳細信息
                selectedCardName.textContent = selectedCard.name;
                selectedCardUid.textContent = selectedCard.uid;
                selectedCardType.textContent = selectedCard.type;
                selectedCardData.textContent = selectedCard.data;
                selectedCardInfo.style.display = 'block';
                
                buttonText.textContent = 'WRITE SELECTED CARD';
                controlButton.disabled = false;
            });
            
            // 寫入按鈕點擊事件
            controlButton.addEventListener('click', function() {
                // 隱藏先前的結果
                writeResult.style.display = 'none';
                
                // 顯示loading狀態
                controlButton.disabled = true;
                loadingSpinner.style.display = 'inline-block';
                buttonText.textContent = 'WRITING...';
                statusIndicator.textContent = 'PLACE YOUR BLANK CARD NEAR THE READER';
                statusIndicator.className = 'status-indicator status-running';
                
                let writeData;
                let saveToDB = false;
                
                // 根據模式獲取寫入數據
                if (writeMode.value === 'saved') {
                    if (!selectedCard) {
                        showError('No card selected for writing');
                        return;
                    }
                    
                    writeData = {
                        uid: selectedCard.uid,
                        type: selectedCard.type,
                        data: selectedCard.data,
                        name: selectedCard.name
                    };
                } else {
                    // 自定義模式下檢查必填字段
                    if (!customData.value.trim()) {
                        showError('Custom data cannot be empty');
                        return;
                    }
                    
                    writeData = {
                        uid: customUid.value.trim(),
                        type: customCardType.value,
                        data: customData.value.trim(),
                        name: customName.value.trim() || 'Custom Card'
                    };
                    
                    // 如果自定義卡片有名稱，則保存到數據庫
                    saveToDB = customName.value.trim() !== '';
                }
                
                // 發送寫入請求
                fetch('/RFID/write', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        card_data: writeData,
                        save_to_db: saveToDB
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Write response:', data);
                    if (data.success) {
                        // 如果是自定義卡片並設置了保存
                        if (writeMode.value === 'custom' && saveToDB) {
                            // 創建卡片對象
                            const cardObject = {
                                name: writeData.name,
                                uid: writeData.uid || data.written_uid || 'N/A',
                                type: writeData.type,
                                data: writeData.data,
                                scanTime: new Date().toLocaleString(),
                                timestamp: new Date().getTime()
                            };
                            
                            // 檢查是否存在相同 UID 的卡片
                            const existingIndex = cardCollection.findIndex(card => card.uid === cardObject.uid);
                            if (existingIndex !== -1) {
                                // 更新已存在的卡片
                                cardCollection[existingIndex] = cardObject;
                            } else {
                                // 添加新卡片
                                cardCollection.push(cardObject);
                            }
                            
                            // 儲存到 localStorage
                            localStorage.setItem('rfidCards', JSON.stringify(cardCollection));
                            
                            // 更新選擇列表
                            populateSavedCardSelect();
                        }
                        
                        // 顯示成功信息
                        statusIndicator.textContent = 'CARD WRITTEN SUCCESSFULLY';
                        statusIndicator.className = 'status-indicator status-running';
                        
                        // 顯示詳細結果
                        resultContent.innerHTML = `
                            <p><strong>Success!</strong> The data has been written to the card.</p>
                            <p><strong>Card UID:</strong> ${data.written_uid || writeData.uid || 'Not changed'}</p>
                            <p><strong>Card Type:</strong> ${writeData.type}</p>
                            <p><strong>Sectors Written:</strong> ${data.sectors_written || 'All requested sectors'}</p>
                            <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                        `;
                        writeResult.style.display = 'block';
                    } else {
                        throw new Error(data.message || 'Write operation failed');
                    }
                })
                .catch(error => {
                    console.error('Error writing to card:', error);
                    showError('Failed to write to card: ' + error.message);
                })
                .finally(() => {
                    // 重置按鈕狀態
                    loadingSpinner.style.display = 'none';
                    buttonText.textContent = writeMode.value === 'saved' ? 'WRITE SELECTED CARD' : 'WRITE CUSTOM DATA';
                    controlButton.disabled = false;
                });
            });
            
            // 顯示錯誤
            function showError(message) {
                statusIndicator.textContent = 'ERROR: ' + message.toUpperCase();
                statusIndicator.className = 'status-indicator status-stopped';
                loadingSpinner.style.display = 'none';
                controlButton.disabled = false;
                
                resultContent.innerHTML = `<p class="error-message">${message}</p>`;
                writeResult.style.display = 'block';
            }
            
            // 初始檢查，如果沒有保存的卡片，禁用寫入按鈕
            if (cardCollection.length === 0 && writeMode.value === 'saved') {
                controlButton.disabled = true;
                statusIndicator.textContent = 'NO SAVED CARDS AVAILABLE';
            }
        });
    </script>
</body>
</html>