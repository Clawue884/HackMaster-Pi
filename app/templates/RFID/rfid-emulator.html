<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <title>RFID Emulator - HackMaster Pi</title>
    <meta name="theme-color" content="#0f0f17">
</head>
<body>
    <div class="container">
        <div class="header-container">
            <a href="/" class="back-button">← BACK</a>
            <h1>RFID Emulator</h1>
        </div>
        
        <div class="info-guide">
            <h3>RFID Emulation Tool</h3>
            <p>This tool allows you to emulate RFID cards by specifying custom UID and data. Use your Raspberry Pi to simulate a physical RFID card.</p>
            <p><strong>Note:</strong> This feature requires compatible NFC hardware with card emulation capability.</p>
        </div>
        
        <div class="control-panel">
            <h2>Emulation Settings</h2>
            
            <div class="form-group">
                <label for="emulation-mode">EMULATION MODE:</label>
                <select id="emulation-mode" class="profile-select">
                    <option value="custom">CUSTOM SETTINGS</option>
                    <option value="saved">FROM SAVED CARDS</option>
                </select>
            </div>
            
            <!-- 自定義設置面板 -->
            <div id="custom-panel" class="write-mode-panel">
                <div class="form-group">
                    <label for="card-uid">UID (HEXADECIMAL):</label>
                    <input type="text" id="card-uid" placeholder="Enter UID in hex format (e.g., 1A2B3C4D)" maxlength="16">
                </div>
                
                <div class="form-group">
                    <label for="card-type">CARD TYPE:</label>
                    <select id="card-type">
                        <option value="Mifare Classic 1K">MIFARE CLASSIC 1K</option>
                        <option value="Mifare Classic 4K">MIFARE CLASSIC 4K</option>
                        <option value="Mifare Ultralight">MIFARE ULTRALIGHT</option>
                        <option value="Mifare Desfire">MIFARE DESFIRE</option>
                        <option value="ISO 14443A">ISO 14443A</option>
                        <option value="Other">OTHER</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="card-data">CARD DATA:</label>
                    <textarea id="card-data" rows="5" placeholder="Enter data to be emulated"></textarea>
                </div>
            </div>
            
            <!-- 已保存卡片選擇面板 -->
            <div id="saved-panel" class="write-mode-panel" style="display: none;">
                <div class="form-group">
                    <label for="saved-card-select">SELECT SAVED CARD:</label>
                    <select id="saved-card-select" class="profile-select">
                        <option value="">-- SELECT A CARD --</option>
                    </select>
                </div>
                
                <div id="selected-card-info" class="profile-item" style="display: none;">
                    <div class="profile-details">
                        <div class="profile-name" id="selected-card-name">Card Name</div>
                        <div class="profile-info">
                            <span class="profile-label">UID:</span>
                            <span class="profile-value" id="selected-card-uid">-</span>
                        </div>
                        <div class="profile-info">
                            <span class="profile-label">TYPE:</span>
                            <span class="profile-value" id="selected-card-type">-</span>
                        </div>
                        <div class="profile-info">
                            <span class="profile-label">DATA:</span>
                            <span class="profile-value" id="selected-card-data">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="control-button" type="button">
                <span id="button-text">START EMULATION</span>
                <span class="loading" id="loading-spinner" style="display: none;"></span>
            </button>
        </div>
        
        <div class="status-indicator" id="status-indicator">READY TO EMULATE</div>
        
        <div id="emulation-stats" style="display: none; margin-top: 30px;">
            <h2>Emulation Statistics</h2>
            <div class="profile-item">
                <div class="profile-details">
                    <div class="profile-info">
                        <span class="profile-label">STATUS:</span>
                        <span class="profile-value" id="emulation-status">Inactive</span>
                    </div>
                    <div class="profile-info">
                        <span class="profile-label">RUNTIME:</span>
                        <span class="profile-value" id="emulation-runtime">00:00:00</span>
                    </div>
                    <div class="profile-info">
                        <span class="profile-label">READ ATTEMPTS:</span>
                        <span class="profile-value" id="read-attempts">0</span>
                    </div>
                    <div class="profile-info">
                        <span class="profile-label">LAST READ:</span>
                        <span class="profile-value" id="last-read">Never</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM 元素
            const emulationMode = document.getElementById('emulation-mode');
            const customPanel = document.getElementById('custom-panel');
            const savedPanel = document.getElementById('saved-panel');
            const savedCardSelect = document.getElementById('saved-card-select');
            const selectedCardInfo = document.getElementById('selected-card-info');
            const selectedCardName = document.getElementById('selected-card-name');
            const selectedCardUid = document.getElementById('selected-card-uid');
            const selectedCardType = document.getElementById('selected-card-type');
            const selectedCardData = document.getElementById('selected-card-data');
            const cardUid = document.getElementById('card-uid');
            const cardType = document.getElementById('card-type');
            const cardData = document.getElementById('card-data');
            const controlButton = document.getElementById('control-button');
            const buttonText = document.getElementById('button-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const statusIndicator = document.getElementById('status-indicator');
            const emulationStats = document.getElementById('emulation-stats');
            const emulationStatus = document.getElementById('emulation-status');
            const emulationRuntime = document.getElementById('emulation-runtime');
            const readAttempts = document.getElementById('read-attempts');
            const lastRead = document.getElementById('last-read');
            
            // 模擬狀態變數
            let isEmulating = false;
            let startTime = null;
            let runtimeInterval = null;
            let statsUpdateInterval = null;
            let attemptCount = 0;
            
            // 儲存卡片集合
            let cardCollection = [];
            let selectedCard = null;
            
            // 嘗試從 localStorage 加載已儲存的卡片
            try {
                const savedCards = localStorage.getItem('rfidCards');
                if (savedCards) {
                    cardCollection = JSON.parse(savedCards);
                    populateSavedCardSelect();
                }
            } catch (e) {
                console.error('Error loading saved cards:', e);
            }
            
            // 填充已保存卡片選擇下拉框
            function populateSavedCardSelect() {
                // 清空現有選項（保留第一個）
                while (savedCardSelect.options.length > 1) {
                    savedCardSelect.remove(1);
                }
                
                // 沒有卡片的情況
                if (cardCollection.length === 0) {
                    const option = document.createElement('option');
                    option.text = 'NO SAVED CARDS AVAILABLE';
                    option.disabled = true;
                    savedCardSelect.add(option);
                    return;
                }
                
                // 添加每個卡片作為選項
                cardCollection.forEach((card, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.text = `${card.name} (${card.uid})`;
                    savedCardSelect.add(option);
                });
            }
            
            // 模式切換
            emulationMode.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customPanel.style.display = 'block';
                    savedPanel.style.display = 'none';
                    selectedCard = null;
                } else {
                    customPanel.style.display = 'none';
                    savedPanel.style.display = 'block';
                    
                    // 如果沒有選擇卡片，檢查是否有可用的卡片
                    if (savedCardSelect.options.length <= 1) {
                        statusIndicator.textContent = 'NO SAVED CARDS AVAILABLE';
                        statusIndicator.className = 'status-indicator status-stopped';
                    } else if (savedCardSelect.value === '') {
                        statusIndicator.textContent = 'SELECT A SAVED CARD TO EMULATE';
                    }
                }
            });
            
            // 選擇已保存卡片
            savedCardSelect.addEventListener('change', function() {
                if (this.value === '') {
                    selectedCardInfo.style.display = 'none';
                    selectedCard = null;
                    return;
                }
                
                const index = parseInt(this.value);
                selectedCard = cardCollection[index];
                
                // 顯示選中卡片的詳細信息
                selectedCardName.textContent = selectedCard.name;
                selectedCardUid.textContent = selectedCard.uid;
                selectedCardType.textContent = selectedCard.type;
                selectedCardData.textContent = selectedCard.data;
                selectedCardInfo.style.display = 'block';
                
                statusIndicator.textContent = 'READY TO EMULATE SELECTED CARD';
                statusIndicator.className = 'status-indicator';
            });
            
            // 啟動/停止按鈕
            controlButton.addEventListener('click', function() {
                if (isEmulating) {
                    // 停止模擬
                    stopEmulation();
                } else {
                    // 開始模擬
                    startEmulation();
                }
            });
            
            // 開始模擬函數
            function startEmulation() {
                let emulationData = {};
                
                // 根據模式獲取要模擬的數據
                if (emulationMode.value === 'saved') {
                    if (!selectedCard) {
                        showError('No card selected for emulation');
                        return;
                    }
                    
                    emulationData = {
                        uid: selectedCard.uid,
                        type: selectedCard.type,
                        data: selectedCard.data
                    };
                } else {
                    // 自定義模式
                    const uid = cardUid.value.trim();
                    const data = cardData.value.trim();
                    
                    if (!uid) {
                        showError('UID cannot be empty');
                        return;
                    }
                    
                    if (!data) {
                        showError('Card data cannot be empty');
                        return;
                    }
                    
                    emulationData = {
                        uid: uid,
                        type: cardType.value,
                        data: data
                    };
                }
                
                // 顯示加載狀態
                controlButton.disabled = true;
                loadingSpinner.style.display = 'inline-block';
                buttonText.textContent = 'STARTING...';
                statusIndicator.textContent = 'INITIALIZING EMULATION...';
                statusIndicator.className = 'status-indicator status-running';
                
                // 發送開始模擬請求
                fetch('/RFID/emulate/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emulationData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Emulation start response:', data);
                    if (data.success) {
                        // 更新 UI 為正在模擬狀態
                        isEmulating = true;
                        controlButton.disabled = false;
                        loadingSpinner.style.display = 'none';
                        buttonText.textContent = 'STOP EMULATION';
                        controlButton.classList.add('stop');
                        statusIndicator.textContent = 'EMULATION ACTIVE';
                        statusIndicator.className = 'status-indicator status-running';
                        
                        // 顯示統計信息區域
                        emulationStatus.textContent = 'Active';
                        emulationStats.style.display = 'block';
                        
                        // 開始計時
                        startTime = new Date();
                        attemptCount = 0;
                        updateRuntime();
                        
                        // 設置定時更新統計信息
                        runtimeInterval = setInterval(updateRuntime, 1000);
                        statsUpdateInterval = setInterval(updateStats, 5000);
                    } else {
                        throw new Error(data.message || 'Failed to start emulation');
                    }
                })
                .catch(error => {
                    console.error('Error starting emulation:', error);
                    showError('Failed to start emulation: ' + error.message);
                });
            }
            
            // 停止模擬函數
            function stopEmulation() {
                // 顯示加載狀態
                controlButton.disabled = true;
                loadingSpinner.style.display = 'inline-block';
                buttonText.textContent = 'STOPPING...';
                
                // 發送停止模擬請求
                fetch('/RFID/emulate/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Emulation stop response:', data);
                    if (data.success) {
                        // 停止計時和更新
                        clearInterval(runtimeInterval);
                        clearInterval(statsUpdateInterval);
                        
                        // 更新 UI 為停止狀態
                        isEmulating = false;
                        controlButton.disabled = false;
                        loadingSpinner.style.display = 'none';
                        buttonText.textContent = 'START EMULATION';
                        controlButton.classList.remove('stop');
                        statusIndicator.textContent = 'EMULATION STOPPED';
                        statusIndicator.className = 'status-indicator';
                        
                        // 更新狀態顯示
                        emulationStatus.textContent = 'Inactive';
                    } else {
                        throw new Error(data.message || 'Failed to stop emulation');
                    }
                })
                .catch(error => {
                    console.error('Error stopping emulation:', error);
                    showError('Failed to stop emulation: ' + error.message);
                    
                    // 重置按鈕狀態，即使發生錯誤
                    isEmulating = false;
                    controlButton.disabled = false;
                    loadingSpinner.style.display = 'none';
                    buttonText.textContent = 'START EMULATION';
                    controlButton.classList.remove('stop');
                });
            }
            
            // 更新運行時間
            function updateRuntime() {
                if (!startTime) return;
                
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(diff / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                
                emulationRuntime.textContent = `${hours}:${minutes}:${seconds}`;
            }
            
            // 更新統計信息
            function updateStats() {
                if (!isEmulating) return;
                
                fetch('/RFID/emulate/stats')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 更新嘗試讀取次數
                            if (data.read_attempts > attemptCount) {
                                attemptCount = data.read_attempts;
                                readAttempts.textContent = attemptCount;
                                lastRead.textContent = new Date().toLocaleString();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error updating stats:', error);
                    });
            }
            
            // 顯示錯誤函數
            function showError(message) {
                statusIndicator.textContent = 'ERROR: ' + message.toUpperCase();
                statusIndicator.className = 'status-indicator status-stopped';
                controlButton.disabled = false;
                loadingSpinner.style.display = 'none';
                
                if (isEmulating) {
                    buttonText.textContent = 'STOP EMULATION';
                } else {
                    buttonText.textContent = 'START EMULATION';
                }
            }
        });
    </script>
</body>
</html>