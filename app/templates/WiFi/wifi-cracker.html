<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <title>Wi-Fi Password Cracker - HackMaster Pi</title>
    <meta name="theme-color" content="#0f0f17">
</head>
<body>
    <div class="container">
        <h1>1. List Adapter</h1>
        
        <button onclick="listAdapters()">List Adapters</button>
        <div id="adapterResponse"></div>

        <h1>2. Activate Monitor Mode</h1>
        <select id="interfaceSelect">
            <option value="">-- Select an interface --</option>
        </select>
        <button onclick="activateMonitorMode()">Activate Monitor Mode</button>
        <p id="monitorStatus">The {} network interface status: </p>
         
        <h1>3. Scan Wi-Fi Networks</h1>
        <button id="scanButton" onclick="scanWifiNetworks()">Scan Wi-Fi Networks</button>
        <div id="scanResponse">
            <div id="loadingIndicator" style="display: none;">
                <p>⏳ Scanning for Wi-Fi networks...</p>
            </div>
            <div id="scanResults" style="display: none;">
                <h3>Scan Results:</h3>
                <table id="networksTable" border="1">
                    <thead>
                        <tr>
                            <th>BSSID</th>
                            <th>Channel</th>
                            <th>Encryption</th>
                            <th>ESSID</th>
                        </tr>
                    </thead>
                    <tbody id="networksTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <h1>4. Set Channel for Target</h1>
        <select id="targetSelect">
            <option value="">-- Select a target --</option>
        </select>
        <button onclick="setChannel()">Set Channel</button>
        <p id="channelStatus"></p>

        <h1>5. Start Capture</h1>
        <button id="startCaptureButton" onclick="startCapture()">Start Capturing</button>
        <p id="captureStatus"></p>

        <h1>6. Send Deauth Packets</h1>
        <label for="packetCount">Number of packets:</label>
        <input type="number" id="packetCount" value="10" min="1" max="100" style="width: 80px;">
        <button id="sendDeauthButton" onclick="sendDeauthPackets()">Send Deauth Packets</button>
        <p id="deauthStatus"></p>

        <div id="step7" style="display: none;">
            <h4>Step 7: Check Handshakes</h4>
            <p>Check captured packets for WPA handshakes.</p>
            <button id="checkHandshakeButton" onclick="checkHandshakes()">Check Handshakes</button>
            <button id="listCaptureFilesButton" onclick="listCaptureFiles()" style="margin-left: 10px;">List Capture Files</button>
            <div id="handshakeStatus" style="margin-top: 10px; padding: 10px; background-color: #2a2a2a; border-radius: 4px;"></div>
            <div id="captureFilesList" style="margin-top: 10px; display: none;"></div>
            <div id="handshakeResults" style="margin-top: 20px; display: none;">
                <h5>Handshake Analysis Results:</h5>
                <table id="handshakeTable" class="table">
                    <thead>
                        <tr>
                            <th>BSSID</th>
                            <th>ESSID</th>
                            <th>Encryption</th>
                            <th>Handshakes</th>
                        </tr>
                    </thead>
                    <tbody id="handshakeTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <h1>8. Stop Capture</h1>
        <button id="stopCaptureButton" onclick="stopCapture()" disabled>Stop Capturing</button>
        <p id="stopCaptureStatus"></p>

    </div>

    <script>
        let selectedInterface = '';
        let scannedNetworks = [];
        let selectedTarget = null;
        let targetChannel = null;
        let targetBSSID = null;
        let targetESSID = null;

        async function listAdapters() {
            try {
                const response = await fetch('/WiFi/interface/details');
                const data = await response.json();
                
                const responseDiv = document.getElementById('adapterResponse');
                
                if (data.success) {
                    responseDiv.innerHTML = `
                        <h3>Success</h3>
                        <p>Message: ${data.message}</p>
                        <h4>Output:</h4>
                        <pre>${data.output}</pre>
                    `;
                    
                    // 載入網卡選項
                    loadInterfaceList();
                } else {
                    responseDiv.innerHTML = `
                        <h3>Error</h3>
                        <p>Message: ${data.message}</p>
                        <pre>${data.output || ''}</pre>
                    `;
                }
            } catch (error) {
                document.getElementById('adapterResponse').innerHTML = `
                    <h3>Network Error</h3>
                    <p>${error.message}</p>
                `;
            }
        }

        async function loadInterfaceList() {
            try {
                const response = await fetch('/WiFi/interface/list');
                const data = await response.json();
                
                const select = document.getElementById('interfaceSelect');
                
                if (data.success) {
                    // 清空現有選項
                    select.innerHTML = '<option value="">-- Select an interface --</option>';
                    
                    // 添加網卡選項
                    data.adapters.forEach(adapter => {
                        const option = document.createElement('option');
                        option.value = adapter;
                        option.textContent = adapter;
                        select.appendChild(option);
                    });
                    
                    // 監聽選擇變更
                    select.onchange = function() {
                        selectedInterface = this.value;
                        if (selectedInterface) {
                            checkInterfaceStatus(selectedInterface);
                        }
                    };
                }
            } catch (error) {
                console.error('Error loading interfaces:', error);
            }
        }

        async function activateMonitorMode() {
            if (!selectedInterface) {
                alert('Please select an interface first');
                return;
            }

            try {
                const response = await fetch('/WiFi/interface/monitorMode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interface: selectedInterface
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Monitor mode activated for ${selectedInterface}`);
                    checkInterfaceStatus(selectedInterface);
                } else {
                    alert(`Failed to activate monitor mode: ${data.message}`);
                }
            } catch (error) {
                alert(`Network error: ${error.message}`);
            }
        }

        async function checkInterfaceStatus(interfaceName) {
            try {
                const response = await fetch(`/WiFi/interface/status?interface=${interfaceName}`);
                const data = await response.json();
                
                const statusElement = document.getElementById('monitorStatus');
                
                if (data.success) {
                    statusElement.textContent = `The ${interfaceName} network interface status: ${data.status}`;
                } else {
                    statusElement.textContent = `The ${interfaceName} network interface status: Error - ${data.message}`;
                }
            } catch (error) {
                document.getElementById('monitorStatus').textContent = `The ${interfaceName} network interface status: Error - ${error.message}`;
            }
        }

        async function scanWifiNetworks() {
            if (!selectedInterface) {
                alert('Please select a network interface first');
                return;
            }

            const scanButton = document.getElementById('scanButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const scanResults = document.getElementById('scanResults');
            
            // 禁用掃描按鈕並顯示載入指示器
            scanButton.disabled = true;
            scanButton.textContent = 'Scanning...';
            loadingIndicator.style.display = 'block';
            scanResults.style.display = 'none';

            try {
                // 設定 fetch 超時控制器
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 45000); // 45秒超時，給更多緩衝時間
                
                const response = await fetch('/WiFi/ap/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interface: selectedInterface,
                        timeout: 12  // 減少到 12 秒，更實際的掃描時間
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success && data.ap_list) {
                    displayScanResults(data.ap_list);
                } else {
                    throw new Error(data.message || 'Failed to scan networks');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    alert('Network scan timed out (45 seconds). Please try again.');
                } else {
                    alert(`Network scan failed: ${error.message}`);
                }
                scanResults.style.display = 'none';
            } finally {
                // 恢復掃描按鈕
                scanButton.disabled = false;
                scanButton.textContent = 'Scan Wi-Fi Networks';
                loadingIndicator.style.display = 'none';
            }
        }

        function displayScanResults(networks) {
            const scanResults = document.getElementById('scanResults');
            const tableBody = document.getElementById('networksTableBody');
            
            // 儲存掃描結果
            scannedNetworks = networks;
            
            // 清空表格內容
            tableBody.innerHTML = '';
            
            if (networks.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4">No networks found</td></tr>';
            } else {
                networks.forEach(network => {
                    const row = document.createElement('tr');
                    
                    // BSSID
                    const bssidCell = document.createElement('td');
                    bssidCell.textContent = network.BSSID || 'Unknown';
                    row.appendChild(bssidCell);
                    
                    // Channel
                    const channelCell = document.createElement('td');
                    channelCell.textContent = network.CH || 'Unknown';
                    row.appendChild(channelCell);
                    
                    // Encryption
                    const encryptionCell = document.createElement('td');
                    encryptionCell.textContent = network.ENC || 'Unknown';
                    row.appendChild(encryptionCell);
                    
                    // ESSID
                    const essidCell = document.createElement('td');
                    essidCell.textContent = network.ESSID || '<hidden>';
                    row.appendChild(essidCell);
                    
                    tableBody.appendChild(row);
                });
            }
            
            // 更新目標選擇器
            updateTargetSelect(networks);
            
            scanResults.style.display = 'block';
        }

        function updateTargetSelect(networks) {
            const targetSelect = document.getElementById('targetSelect');
            
            // 清空現有選項
            targetSelect.innerHTML = '<option value="">-- Select a target --</option>';
            
            // 添加網路選項
            networks.forEach((network, index) => {
                const option = document.createElement('option');
                option.value = index;
                const essid = network.ESSID || '<hidden>';
                const bssid = network.BSSID || 'Unknown';
                option.textContent = `${essid} (${bssid})`;
                targetSelect.appendChild(option);
            });
        }

        async function setChannel() {
            const targetSelect = document.getElementById('targetSelect');
            const selectedIndex = targetSelect.value;
            
            if (!selectedIndex) {
                alert('Please select a target network first');
                return;
            }

            if (!selectedInterface) {
                alert('Please select a network interface first');
                return;
            }

            // 獲取選中的目標
            selectedTarget = scannedNetworks[selectedIndex];
            targetChannel = selectedTarget.CH;
            targetBSSID = selectedTarget.BSSID;
            targetESSID = selectedTarget.ESSID || '<hidden>';

            const channelStatus = document.getElementById('channelStatus');
            channelStatus.textContent = 'Setting channel...';

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超時
                
                const response = await fetch('/WiFi/interface/channel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interface: selectedInterface,
                        channel: targetChannel
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success) {
                    channelStatus.textContent = `Channel ${targetChannel} set for ${targetESSID}`;
                } else {
                    channelStatus.textContent = `Failed to set channel - ${data.message}`;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    channelStatus.textContent = 'Channel setting timed out';
                } else {
                    channelStatus.textContent = `Error - ${error.message}`;
                }
            }
        }

        async function startCapture() {
            if (!selectedInterface) {
                alert('Please select a network interface first');
                return;
            }

            if (!targetBSSID || !targetChannel) {
                alert('Please select a target and set channel first');
                return;
            }

            const startButton = document.getElementById('startCaptureButton');
            const stopButton = document.getElementById('stopCaptureButton');
            const captureStatus = document.getElementById('captureStatus');

            // 更新按鈕狀態
            startButton.disabled = true;
            startButton.textContent = 'Starting...';
            captureStatus.textContent = 'Starting capture...';

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超時
                
                const response = await fetch('/WiFi/capture/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interface: selectedInterface,
                        bssid: targetBSSID,
                        channel: parseInt(targetChannel)
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success) {
                    stopButton.disabled = false;
                    captureStatus.textContent = `Capturing traffic for ${targetESSID} on channel ${targetChannel}`;
                    startButton.textContent = 'Capture Started';
                } else {
                    startButton.disabled = false;
                    startButton.textContent = 'Start Capturing';
                    captureStatus.textContent = `Failed to start capture - ${data.message}`;
                }
            } catch (error) {
                startButton.disabled = false;
                startButton.textContent = 'Start Capturing';
                if (error.name === 'AbortError') {
                    captureStatus.textContent = 'Capture start timed out';
                } else {
                    captureStatus.textContent = `Error - ${error.message}`;
                }
            }
        }

        async function stopCapture() {
            const startButton = document.getElementById('startCaptureButton');
            const stopButton = document.getElementById('stopCaptureButton');
            const stopCaptureStatus = document.getElementById('stopCaptureStatus');

            stopButton.disabled = true;
            stopButton.textContent = 'Stopping...';
            stopCaptureStatus.textContent = 'Stopping capture...';

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超時
                
                const response = await fetch('/WiFi/capture/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success) {
                    stopCaptureStatus.textContent = 'Capture stopped successfully';
                    stopButton.textContent = 'Capture Stopped';
                    // 重新啟用 start 按鈕
                    startButton.disabled = false;
                    startButton.textContent = 'Start Capturing';
                } else {
                    stopCaptureStatus.textContent = `Failed to stop capture - ${data.message}`;
                    stopButton.disabled = false;
                    stopButton.textContent = 'Stop Capturing';
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    stopCaptureStatus.textContent = 'Capture stop timed out';
                } else {
                    stopCaptureStatus.textContent = `Error - ${error.message}`;
                }
                stopButton.disabled = false;
                stopButton.textContent = 'Stop Capturing';
            }
        }

        async function sendDeauthPackets() {
            if (!selectedInterface) {
                alert('Please select a network interface first');
                return;
            }

            if (!targetBSSID) {
                alert('Please select a target network first');
                return;
            }

            const deauthButton = document.getElementById('sendDeauthButton');
            const deauthStatus = document.getElementById('deauthStatus');
            const packetCount = document.getElementById('packetCount').value;

            // 驗證封包數量
            const packets = parseInt(packetCount);
            if (isNaN(packets) || packets < 1 || packets > 100) {
                alert('Please enter a valid packet count (1-100)');
                return;
            }

            // 更新按鈕狀態
            deauthButton.disabled = true;
            deauthButton.textContent = 'Sending...';
            deauthStatus.textContent = `Sending ${packets} deauth packets to ${targetESSID}...`;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 45000); // 45秒超時
                
                const response = await fetch('/WiFi/deauth/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interface: selectedInterface,
                        bssid: targetBSSID,
                        packets: packets,
                        broadcast: true
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success) {
                    deauthStatus.textContent = `Successfully sent ${data.packets_sent} deauth packets to ${targetESSID}`;
                } else {
                    deauthStatus.textContent = `Failed to send deauth packets - ${data.message}`;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    deauthStatus.textContent = 'Deauth sending timed out';
                } else {
                    deauthStatus.textContent = `Error - ${error.message}`;
                }
            } finally {
                // 恢復按鈕狀態
                deauthButton.disabled = false;
                deauthButton.textContent = 'Send Deauth Packets';
            }
        }

        async function checkHandshakes() {
            const checkButton = document.getElementById('checkHandshakeButton');
            const handshakeStatus = document.getElementById('handshakeStatus');
            const handshakeResults = document.getElementById('handshakeResults');

            // 更新按鈕狀態
            checkButton.disabled = true;
            checkButton.textContent = 'Checking...';
            handshakeStatus.textContent = 'Analyzing capture file for handshakes...';
            handshakeResults.style.display = 'none';

            try {
                // 首先列出可用的 capture 檔案
                let captureFile = 'capture-01.cap';  // 預設檔名
                
                try {
                    const listResponse = await fetch('/WiFi/capture/list');
                    const listData = await listResponse.json();
                    
                    if (listData.success && listData.files.length > 0) {
                        // 使用最新的檔案
                        captureFile = listData.files[0].filename;
                        handshakeStatus.textContent = `Found capture file: ${captureFile}, analyzing for handshakes...`;
                    } else {
                        handshakeStatus.textContent = 'No capture files found, using default filename...';
                    }
                } catch (error) {
                    console.log('Failed to list capture files, using default filename');
                }
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 45000); // 45秒超時
                
                const response = await fetch('/WiFi/handshake/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        capture_file: captureFile
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success) {
                    handshakeStatus.textContent = data.message;
                    displayHandshakeResults(data.networks, data.total_handshakes);
                } else {
                    handshakeStatus.textContent = `Failed to check handshakes - ${data.message}`;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    handshakeStatus.textContent = 'Handshake checking timed out';
                } else {
                    handshakeStatus.textContent = `Error - ${error.message}`;
                }
            } finally {
                // 恢復按鈕狀態
                checkButton.disabled = false;
                checkButton.textContent = 'Check Handshakes';
            }
        }

        function displayHandshakeResults(networks, totalHandshakes) {
            const handshakeResults = document.getElementById('handshakeResults');
            const tableBody = document.getElementById('handshakeTableBody');
            
            // 清空表格內容
            tableBody.innerHTML = '';
            
            if (networks.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">No networks found in capture file</td></tr>';
            } else {
                networks.forEach(network => {
                    const row = document.createElement('tr');
                    
                    // 如果有握手包，高亮顯示
                    if (network.handshakes > 0) {
                        row.style.backgroundColor = '#d4edda'; // 綠色背景
                        row.style.fontWeight = 'bold';
                    }
                    
                    // Number
                    const numberCell = document.createElement('td');
                    numberCell.textContent = network.number;
                    row.appendChild(numberCell);
                    
                    // BSSID
                    const bssidCell = document.createElement('td');
                    bssidCell.textContent = network.bssid || 'Unknown';
                    row.appendChild(bssidCell);
                    
                    // ESSID
                    const essidCell = document.createElement('td');
                    essidCell.textContent = network.essid || '<hidden>';
                    row.appendChild(essidCell);
                    
                    // Encryption
                    const encryptionCell = document.createElement('td');
                    encryptionCell.textContent = network.encryption || 'Unknown';
                    row.appendChild(encryptionCell);
                    
                    // Handshakes
                    const handshakesCell = document.createElement('td');
                    handshakesCell.textContent = network.handshakes;
                    if (network.handshakes > 0) {
                        handshakesCell.style.color = '#155724'; // 深綠色字體
                    }
                    row.appendChild(handshakesCell);
                    
                    tableBody.appendChild(row);
                });
            }
            
            handshakeResults.style.display = 'block';
        }

        async function listCaptureFiles() {
            const listButton = document.getElementById('listCaptureFilesButton');
            const captureFilesList = document.getElementById('captureFilesList');

            // 更新按鈕狀態
            listButton.disabled = true;
            listButton.textContent = 'Listing...';

            try {
                const response = await fetch('/WiFi/capture/list');
                const data = await response.json();
                
                if (data.success) {
                    if (data.files.length > 0) {
                        let fileListHtml = '<h5>Available Capture Files:</h5><ul>';
                        data.files.forEach(file => {
                            const modifiedDate = new Date(file.modified * 1000).toLocaleString();
                            const sizeKB = (file.size / 1024).toFixed(2);
                            fileListHtml += `<li><strong>${file.filename}</strong> - ${sizeKB} KB - Modified: ${modifiedDate}</li>`;
                        });
                        fileListHtml += '</ul>';
                        captureFilesList.innerHTML = fileListHtml;
                        captureFilesList.style.display = 'block';
                    } else {
                        captureFilesList.innerHTML = '<p>No capture files found.</p>';
                        captureFilesList.style.display = 'block';
                    }
                } else {
                    captureFilesList.innerHTML = `<p>Error: ${data.message}</p>`;
                    captureFilesList.style.display = 'block';
                }
            } catch (error) {
                captureFilesList.innerHTML = `<p>Failed to list capture files: ${error.message}</p>`;
                captureFilesList.style.display = 'block';
            } finally {
                // 恢復按鈕狀態
                listButton.disabled = false;
                listButton.textContent = 'List Capture Files';
            }
        }
    </script>
</body>
</html>