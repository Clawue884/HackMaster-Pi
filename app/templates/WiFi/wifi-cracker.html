<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <title>Wi-Fi Password Cracker - HackMaster Pi</title>
    <meta name="theme-color" content="#0f0f17">
</head>
<body>
    <div class="container">
        <h1>1. List Adapter</h1>
        
        <button onclick="listAdapters()">List Adapters</button>
        <div id="adapterResponse"></div>

        <h1>2. Activate Monitor Mode</h1>
        <select id="interfaceSelect">
            <option value="">-- Select an interface --</option>
        </select>
        <button onclick="activateMonitorMode()">Activate Monitor Mode</button>
        <p id="monitorStatus">The {} network interface status: </p>
         
        <h1>3. Scan Wi-Fi Networks</h1>
        <button id="scanButton" onclick="scanWifiNetworks()">Scan Wi-Fi Networks</button>
        <div id="scanResponse">
            <div id="loadingIndicator" style="display: none;">
                <p>⏳ Scanning for Wi-Fi networks...</p>
            </div>
            <div id="scanResults" style="display: none;">
                <h3>Scan Results:</h3>
                <table id="networksTable" border="1">
                    <thead>
                        <tr>
                            <th>BSSID</th>
                            <th>Channel</th>
                            <th>Encryption</th>
                            <th>ESSID</th>
                        </tr>
                    </thead>
                    <tbody id="networksTableBody">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        let selectedInterface = '';

        async function listAdapters() {
            try {
                const response = await fetch('/WiFi/interface/details');
                const data = await response.json();
                
                const responseDiv = document.getElementById('adapterResponse');
                
                if (data.success) {
                    responseDiv.innerHTML = `
                        <h3>Success</h3>
                        <p>Message: ${data.message}</p>
                        <h4>Output:</h4>
                        <pre>${data.output}</pre>
                    `;
                    
                    // 載入網卡選項
                    loadInterfaceList();
                } else {
                    responseDiv.innerHTML = `
                        <h3>Error</h3>
                        <p>Message: ${data.message}</p>
                        <pre>${data.output || ''}</pre>
                    `;
                }
            } catch (error) {
                document.getElementById('adapterResponse').innerHTML = `
                    <h3>Network Error</h3>
                    <p>${error.message}</p>
                `;
            }
        }

        async function loadInterfaceList() {
            try {
                const response = await fetch('/WiFi/interface/list');
                const data = await response.json();
                
                const select = document.getElementById('interfaceSelect');
                
                if (data.success) {
                    // 清空現有選項
                    select.innerHTML = '<option value="">-- Select an interface --</option>';
                    
                    // 添加網卡選項
                    data.adapters.forEach(adapter => {
                        const option = document.createElement('option');
                        option.value = adapter;
                        option.textContent = adapter;
                        select.appendChild(option);
                    });
                    
                    // 監聽選擇變更
                    select.onchange = function() {
                        selectedInterface = this.value;
                        if (selectedInterface) {
                            checkInterfaceStatus(selectedInterface);
                        }
                    };
                }
            } catch (error) {
                console.error('Error loading interfaces:', error);
            }
        }

        async function activateMonitorMode() {
            if (!selectedInterface) {
                alert('Please select an interface first');
                return;
            }

            try {
                const response = await fetch('/WiFi/interface/monitorMode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interface: selectedInterface
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Monitor mode activated for ${selectedInterface}`);
                    checkInterfaceStatus(selectedInterface);
                } else {
                    alert(`Failed to activate monitor mode: ${data.message}`);
                }
            } catch (error) {
                alert(`Network error: ${error.message}`);
            }
        }

        async function checkInterfaceStatus(interfaceName) {
            try {
                const response = await fetch(`/WiFi/interface/status?interface=${interfaceName}`);
                const data = await response.json();
                
                const statusElement = document.getElementById('monitorStatus');
                
                if (data.success) {
                    statusElement.textContent = `The ${interfaceName} network interface status: ${data.status}`;
                } else {
                    statusElement.textContent = `The ${interfaceName} network interface status: Error - ${data.message}`;
                }
            } catch (error) {
                document.getElementById('monitorStatus').textContent = `The ${interfaceName} network interface status: Error - ${error.message}`;
            }
        }

        async function scanWifiNetworks() {
            if (!selectedInterface) {
                alert('Please select a network interface first');
                return;
            }

            const scanButton = document.getElementById('scanButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const scanResults = document.getElementById('scanResults');
            
            // 禁用掃描按鈕並顯示載入指示器
            scanButton.disabled = true;
            scanButton.textContent = 'Scanning...';
            loadingIndicator.style.display = 'block';
            scanResults.style.display = 'none';

            try {
                const response = await fetch('/WiFi/ap/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interface: selectedInterface,
                        timeout: 3
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.ap_list) {
                    displayScanResults(data.ap_list);
                } else {
                    throw new Error(data.message || 'Failed to scan networks');
                }
            } catch (error) {
                alert(`Network scan failed: ${error.message}`);
                scanResults.style.display = 'none';
            } finally {
                // 恢復掃描按鈕
                scanButton.disabled = false;
                scanButton.textContent = 'Scan Wi-Fi Networks';
                loadingIndicator.style.display = 'none';
            }
        }

        function displayScanResults(networks) {
            const scanResults = document.getElementById('scanResults');
            const tableBody = document.getElementById('networksTableBody');
            
            // 清空表格內容
            tableBody.innerHTML = '';
            
            if (networks.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4">No networks found</td></tr>';
            } else {
                networks.forEach(network => {
                    const row = document.createElement('tr');
                    
                    // BSSID
                    const bssidCell = document.createElement('td');
                    bssidCell.textContent = network.BSSID || 'Unknown';
                    row.appendChild(bssidCell);
                    
                    // Channel
                    const channelCell = document.createElement('td');
                    channelCell.textContent = network.CH || 'Unknown';
                    row.appendChild(channelCell);
                    
                    // Encryption
                    const encryptionCell = document.createElement('td');
                    encryptionCell.textContent = network.ENC || 'Unknown';
                    row.appendChild(encryptionCell);
                    
                    // ESSID
                    const essidCell = document.createElement('td');
                    essidCell.textContent = network.ESSID || '<hidden>';
                    row.appendChild(essidCell);
                    
                    tableBody.appendChild(row);
                });
            }
            
            scanResults.style.display = 'block';
        }
    </script>