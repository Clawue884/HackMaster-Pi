<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <title>IR Signal Learner - HackMaster Pi</title>
    <meta name="theme-color" content="#0f0f17">
</head>
<body>
    <div class="container">
        <div class="header-container">
            <a href="/" class="back-button">← BACK</a>
            <h1>IR Signal Learner</h1>
        </div>
        
        <div class="info-guide">
            <h3>IR Signal Learning Tool</h3>
            <p>This tool allows you to record, store and transmit infrared signals. Point a remote control at the IR receiver, press a button, save the signal with a descriptive name, and you can replay it later.</p>
        </div>
        
        <div class="control-panel">
            <h2>Record New Signal</h2>
            <button id="record-button" type="button" class="start-btn">
                <span id="record-button-text">START RECORDING</span>
                <span class="loading" id="record-spinner" style="display: none;"></span>
            </button>
            <div class="status-indicator" id="record-status">READY TO RECORD</div>
            
            <div id="signal-info" style="display: none;">
                <div class="form-group" style="margin-top: 20px;">
                    <label for="signal-name">SIGNAL NAME:</label>
                    <input type="text" id="signal-name" placeholder="Enter a name for this signal (e.g., TV Power)">
                </div>
                <div class="form-group">
                    <label for="signal-description">DESCRIPTION (OPTIONAL):</label>
                    <input type="text" id="signal-description" placeholder="Enter additional information about this signal">
                </div>
                <div class="profile-item">
                    <div class="profile-details">
                        <div class="profile-info">
                            <span class="profile-label">SIGNAL DATA:</span>
                            <span class="profile-value" id="signal-data">-</span>
                        </div>
                        <div class="profile-info">
                            <span class="profile-label">FORMAT:</span>
                            <span class="profile-value" id="signal-format">-</span>
                        </div>
                        <div class="profile-info">
                            <span class="profile-label">LENGTH:</span>
                            <span class="profile-value" id="signal-length">-</span>
                        </div>
                    </div>
                </div>
                <button id="save-button" class="start-btn">SAVE SIGNAL</button>
            </div>
        </div>
        
        <div class="control-panel" style="margin-top: 30px;">
            <h2>Transmit Signals</h2>
            <div class="form-group">
                <label for="signal-select">SELECT SIGNAL TO TRANSMIT:</label>
                <select id="signal-select" class="profile-select">
                    <option value="">-- SELECT A SIGNAL --</option>
                </select>
            </div>
            
            <div id="selected-signal-info" class="profile-item" style="display: none;">
                <div class="profile-details">
                    <div class="profile-name" id="selected-signal-name">Signal Name</div>
                    <div class="profile-info">
                        <span class="profile-label">DESCRIPTION:</span>
                        <span class="profile-value" id="selected-signal-description">-</span>
                    </div>
                    <div class="profile-info">
                        <span class="profile-label">FORMAT:</span>
                        <span class="profile-value" id="selected-signal-format">-</span>
                    </div>
                    <div class="profile-info">
                        <span class="profile-label">RECORDED:</span>
                        <span class="profile-value" id="selected-signal-timestamp">-</span>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button id="transmit-button" class="start-btn" disabled>
                    <span id="transmit-button-text">TRANSMIT SIGNAL</span>
                    <span class="loading" id="transmit-spinner" style="display: none;"></span>
                </button>
                <button id="delete-button" class="delete-btn" disabled>DELETE SIGNAL</button>
            </div>
            <div class="status-indicator" id="transmit-status">SELECT A SIGNAL TO TRANSMIT</div>
        </div>
        
        <div id="saved-signals" style="margin-top: 30px;">
            <h2>Saved Signals</h2>
            <div id="signals-list" class="profile-list">
                <div class="no-profiles" id="no-signals-message">No signals saved yet</div>
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button id="export-button" class="download-link">EXPORT ALL SIGNALS</button>
                <label for="import-file" class="start-btn" style="display: inline-block; cursor: pointer;">IMPORT SIGNALS</label>
                <input type="file" id="import-file" style="display: none;" accept=".json">
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM 元素
            const recordButton = document.getElementById('record-button');
            const recordButtonText = document.getElementById('record-button-text');
            const recordSpinner = document.getElementById('record-spinner');
            const recordStatus = document.getElementById('record-status');
            const signalInfo = document.getElementById('signal-info');
            const signalName = document.getElementById('signal-name');
            const signalDescription = document.getElementById('signal-description');
            const signalData = document.getElementById('signal-data');
            const signalFormat = document.getElementById('signal-format');
            const signalLength = document.getElementById('signal-length');
            const saveButton = document.getElementById('save-button');
            const signalSelect = document.getElementById('signal-select');
            const selectedSignalInfo = document.getElementById('selected-signal-info');
            const selectedSignalName = document.getElementById('selected-signal-name');
            const selectedSignalDescription = document.getElementById('selected-signal-description');
            const selectedSignalFormat = document.getElementById('selected-signal-format');
            const selectedSignalTimestamp = document.getElementById('selected-signal-timestamp');
            const transmitButton = document.getElementById('transmit-button');
            const transmitButtonText = document.getElementById('transmit-button-text');
            const transmitSpinner = document.getElementById('transmit-spinner');
            const transmitStatus = document.getElementById('transmit-status');
            const deleteButton = document.getElementById('delete-button');
            const signalsList = document.getElementById('signals-list');
            const noSignalsMessage = document.getElementById('no-signals-message');
            const exportButton = document.getElementById('export-button');
            const importFile = document.getElementById('import-file');
            
            // 儲存訊號集合
            let signalCollection = [];
            let currentSignal = null;
            let isRecording = false;
            
            // 嘗試從 localStorage 加載已儲存的訊號
            try {
                const savedSignals = localStorage.getItem('irSignals');
                if (savedSignals) {
                    signalCollection = JSON.parse(savedSignals);
                    updateSignalsList();
                    populateSignalSelect();
                }
            } catch (e) {
                console.error('Error loading saved signals:', e);
            }
            
            // 錄製按鈕點擊事件
            recordButton.addEventListener('click', function() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
            
            // 開始錄製函數
            function startRecording() {
                // 顯示加載狀態
                recordButton.disabled = true;
                recordSpinner.style.display = 'inline-block';
                recordButtonText.textContent = 'RECORDING...';
                recordStatus.textContent = 'POINT REMOTE AT IR RECEIVER AND PRESS A BUTTON';
                recordStatus.className = 'status-indicator status-running';
                signalInfo.style.display = 'none';
                
                // 發送錄製請求
                fetch('/IR/record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isRecording = true;
                        // 開始輪詢錄製狀態
                        pollRecordingStatus();
                    } else {
                        throw new Error(data.message || 'Failed to start recording');
                    }
                })
                .catch(error => {
                    console.error('Error starting recording:', error);
                    recordStatus.textContent = 'ERROR: ' + error.message.toUpperCase();
                    recordStatus.className = 'status-indicator status-stopped';
                    recordSpinner.style.display = 'none';
                    recordButtonText.textContent = 'START RECORDING';
                    recordButton.disabled = false;
                });
            }
            
            // 輪詢錄製狀態
            function pollRecordingStatus() {
                if (!isRecording) return;
                
                fetch('/IR/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'completed') {
                            // 錄製完成
                            currentSignal = data.signal;
                            displaySignalInfo(currentSignal);
                            stopRecording(false);
                        } else if (data.status === 'recording') {
                            // 繼續錄製中
                            setTimeout(pollRecordingStatus, 1000);
                        } else if (data.status === 'error') {
                            throw new Error(data.message || 'Recording failed');
                        } else if (data.status === 'timeout') {
                            throw new Error('Recording timed out. No signal detected.');
                        } else {
                            // 未知狀態，繼續輪詢
                            setTimeout(pollRecordingStatus, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling recording status:', error);
                        recordStatus.textContent = 'ERROR: ' + error.message.toUpperCase();
                        recordStatus.className = 'status-indicator status-stopped';
                        stopRecording(false);
                    });
            }
            
            // 停止錄製函數
            function stopRecording(cancelRequest = true) {
                isRecording = false;
                
                if (cancelRequest) {
                    // 發送取消錄製請求
                    fetch('/IR/record/cancel', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Cancelled recording:', data);
                    })
                    .catch(error => {
                        console.error('Error cancelling recording:', error);
                    });
                }
                
                // 更新 UI
                recordSpinner.style.display = 'none';
                recordButtonText.textContent = 'START RECORDING';
                recordButton.disabled = false;
                
                if (!currentSignal) {
                    recordStatus.textContent = 'RECORDING CANCELLED';
                    recordStatus.className = 'status-indicator';
                }
            }
            
            // 顯示訊號資訊
            function displaySignalInfo(signal) {
                signalData.textContent = signal.data.substring(0, 20) + '...';
                signalFormat.textContent = signal.format || 'Unknown';
                signalLength.textContent = signal.length + ' bits';
                signalInfo.style.display = 'block';
                recordStatus.textContent = 'SIGNAL RECORDED SUCCESSFULLY';
                recordStatus.className = 'status-indicator status-running';
            }
            
            // 儲存按鈕點擊事件
            saveButton.addEventListener('click', function() {
                const name = signalName.value.trim();
                if (!name) {
                    recordStatus.textContent = 'ERROR: SIGNAL NAME CANNOT BE EMPTY';
                    recordStatus.className = 'status-indicator status-stopped';
                    return;
                }
                
                if (!currentSignal) {
                    recordStatus.textContent = 'ERROR: NO SIGNAL TO SAVE';
                    recordStatus.className = 'status-indicator status-stopped';
                    return;
                }
                
                // 創建訊號物件
                const signalObject = {
                    name: name,
                    description: signalDescription.value.trim(),
                    data: currentSignal.data,
                    format: currentSignal.format || 'Unknown',
                    length: currentSignal.length,
                    timestamp: new Date().toISOString(),
                    id: Date.now().toString()
                };
                
                // 檢查是否存在相同名稱的訊號
                const existingIndex = signalCollection.findIndex(signal => signal.name === name);
                if (existingIndex !== -1) {
                    if (!confirm(`A signal named "${name}" already exists. Do you want to replace it?`)) {
                        return;
                    }
                    signalCollection[existingIndex] = signalObject;
                    recordStatus.textContent = 'SIGNAL UPDATED';
                } else {
                    signalCollection.push(signalObject);
                    recordStatus.textContent = 'SIGNAL SAVED';
                }
                
                // 儲存到 localStorage
                localStorage.setItem('irSignals', JSON.stringify(signalCollection));
                
                // 更新訊號列表與選擇框
                updateSignalsList();
                populateSignalSelect();
                
                // 清空表單
                signalName.value = '';
                signalDescription.value = '';
                currentSignal = null;
                signalInfo.style.display = 'none';
            });
            
            // 選擇訊號事件
            signalSelect.addEventListener('change', function() {
                if (this.value === '') {
                    selectedSignalInfo.style.display = 'none';
                    transmitButton.disabled = true;
                    deleteButton.disabled = true;
                    transmitStatus.textContent = 'SELECT A SIGNAL TO TRANSMIT';
                    return;
                }
                
                const signal = signalCollection.find(s => s.id === this.value);
                if (signal) {
                    selectedSignalName.textContent = signal.name;
                    selectedSignalDescription.textContent = signal.description || 'No description';
                    selectedSignalFormat.textContent = signal.format;
                    selectedSignalTimestamp.textContent = new Date(signal.timestamp).toLocaleString();
                    selectedSignalInfo.style.display = 'block';
                    transmitButton.disabled = false;
                    deleteButton.disabled = false;
                    transmitStatus.textContent = 'READY TO TRANSMIT';
                    transmitStatus.className = 'status-indicator';
                }
            });
            
            // 發送訊號按鈕點擊事件
            transmitButton.addEventListener('click', function() {
                const signalId = signalSelect.value;
                if (!signalId) return;
                
                const signal = signalCollection.find(s => s.id === signalId);
                if (!signal) {
                    transmitStatus.textContent = 'ERROR: SIGNAL NOT FOUND';
                    transmitStatus.className = 'status-indicator status-stopped';
                    return;
                }
                
                // 顯示加載狀態
                transmitButton.disabled = true;
                transmitSpinner.style.display = 'inline-block';
                transmitButtonText.textContent = 'TRANSMITTING...';
                transmitStatus.textContent = 'TRANSMITTING SIGNAL...';
                transmitStatus.className = 'status-indicator status-running';
                
                // 發送訊號
                fetch('/IR/transmit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        signalData: signal.data,
                        format: signal.format
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        transmitStatus.textContent = 'SIGNAL TRANSMITTED SUCCESSFULLY';
                    } else {
                        throw new Error(data.message || 'Transmission failed');
                    }
                })
                .catch(error => {
                    console.error('Error transmitting signal:', error);
                    transmitStatus.textContent = 'ERROR: ' + error.message.toUpperCase();
                    transmitStatus.className = 'status-indicator status-stopped';
                })
                .finally(() => {
                    // 重置按鈕狀態
                    transmitButton.disabled = false;
                    transmitSpinner.style.display = 'none';
                    transmitButtonText.textContent = 'TRANSMIT SIGNAL';
                });
            });
            
            // 刪除訊號按鈕點擊事件
            deleteButton.addEventListener('click', function() {
                const signalId = signalSelect.value;
                if (!signalId) return;
                
                if (!confirm('Are you sure you want to delete this signal?')) {
                    return;
                }
                
                // 刪除訊號
                const index = signalCollection.findIndex(signal => signal.id === signalId);
                if (index !== -1) {
                    signalCollection.splice(index, 1);
                    
                    // 更新 localStorage
                    localStorage.setItem('irSignals', JSON.stringify(signalCollection));
                    
                    // 更新 UI
                    updateSignalsList();
                    populateSignalSelect();
                    
                    selectedSignalInfo.style.display = 'none';
                    transmitButton.disabled = true;
                    deleteButton.disabled = true;
                    transmitStatus.textContent = 'SIGNAL DELETED';
                }
            });
            
            // 匯出按鈕點擊事件
            exportButton.addEventListener('click', function() {
                if (signalCollection.length === 0) {
                    alert('No signals to export');
                    return;
                }
                
                // 產生 JSON 檔案
                const dataStr = JSON.stringify(signalCollection, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                // 建立下載連結
                const exportName = 'ir_signals_' + new Date().toISOString().slice(0, 10) + '.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportName);
                linkElement.click();
            });
            
            // 匯入檔案處理
            importFile.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedSignals = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedSignals)) {
                            throw new Error('Invalid format: not an array');
                        }
                        
                        // 驗證匯入的訊號格式
                        for (const signal of importedSignals) {
                            if (!signal.name || !signal.data) {
                                throw new Error('Invalid signal format');
                            }
                            
                            // 確保每個訊號都有唯一 ID
                            if (!signal.id) {
                                signal.id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                        }
                        
                        // 詢問使用者合併或替換
                        let action;
                        if (signalCollection.length > 0) {
                            action = confirm('Do you want to merge with existing signals? Click OK to merge, Cancel to replace.');
                            
                            if (action) {
                                // 合併訊號
                                const merged = [...signalCollection];
                                for (const signal of importedSignals) {
                                    const existingIndex = merged.findIndex(s => s.name === signal.name);
                                    if (existingIndex !== -1) {
                                        merged[existingIndex] = signal;
                                    } else {
                                        merged.push(signal);
                                    }
                                }
                                signalCollection = merged;
                            } else {
                                // 替換訊號
                                signalCollection = importedSignals;
                            }
                        } else {
                            // 沒有現有訊號，直接匯入
                            signalCollection = importedSignals;
                        }
                        
                        // 更新 localStorage
                        localStorage.setItem('irSignals', JSON.stringify(signalCollection));
                        
                        // 更新 UI
                        updateSignalsList();
                        populateSignalSelect();
                        
                        alert(`Successfully imported ${importedSignals.length} signals.`);
                    } catch (error) {
                        console.error('Error importing signals:', error);
                        alert('Failed to import signals: ' + error.message);
                    }
                    
                    // 重置檔案輸入
                    importFile.value = '';
                };
                reader.readAsText(file);
            });
            
            // 更新訊號列表
            function updateSignalsList() {
                // 清空列表
                while (signalsList.firstChild) {
                    signalsList.removeChild(signalsList.firstChild);
                }
                
                // 檢查是否有訊號
                if (signalCollection.length === 0) {
                    signalsList.appendChild(noSignalsMessage);
                    return;
                }
                
                // 添加所有訊號
                signalCollection.forEach(signal => {
                    const signalElement = document.createElement('div');
                    signalElement.className = 'profile-item';
                    
                    signalElement.innerHTML = `
                        <div class="profile-details">
                            <div class="profile-name">${signal.name}</div>
                            <div class="profile-info">
                                <span class="profile-label">DESCRIPTION:</span>
                                <span class="profile-value">${signal.description || 'No description'}</span>
                            </div>
                            <div class="profile-info">
                                <span class="profile-label">FORMAT:</span>
                                <span class="profile-value">${signal.format}</span>
                            </div>
                            <div class="profile-info">
                                <span class="profile-label">RECORDED:</span>
                                <span class="profile-value">${new Date(signal.timestamp).toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                    
                    signalsList.appendChild(signalElement);
                });
            }
            
            // 填充訊號選擇下拉框
            function populateSignalSelect() {
                // 清空現有選項（保留第一個）
                while (signalSelect.options.length > 1) {
                    signalSelect.remove(1);
                }
                
                // 沒有訊號的情況
                if (signalCollection.length === 0) {
                    const option = document.createElement('option');
                    option.text = 'NO SAVED SIGNALS AVAILABLE';
                    option.disabled = true;
                    signalSelect.add(option);
                    return;
                }
                
                // 按名稱排序
                const sortedSignals = [...signalCollection].sort((a, b) => a.name.localeCompare(b.name));
                
                // 添加每個訊號作為選項
                sortedSignals.forEach(signal => {
                    const option = document.createElement('option');
                    option.value = signal.id;
                    option.text = signal.name;
                    signalSelect.add(option);
                });
            }
        });
    </script>
</body>
</html>